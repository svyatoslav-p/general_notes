.. |br| raw:: html

   <br />

WireGuard
#########

Ниже описаны особенности настройки VPN сервера **WireGuard**. Так как в открытых источниках довольно
много этой информации, описаны только особенности.

.. note::
   Настройка на VPS машине **Oracle Cloud**  `описана в статье <https://mateo.cogeanu.com/2020/wireguard-vpn-pihole-on-free-oracle-cloud/>`_ 

Настройка сервера
*****************

Существует множество готовых скриптов для облечения установки, рассмотрим на примере **PiVPN**

#. Скачать и запустить ``curl -L https://install.pivpn.io | bash`` следовать инструкциям

   * Порт по умолчанию ``51820`` можно изменить, но нужно учесть это при дальнейшей настройке 
     (при открытии портов роутера, создания)конфигурационного файла.

   * На этпе выбора DNS можно оставить **Goole** (проверено, работает). Так же если выбрать **PiVPN -is-local-DNS**
     необходимо настроить свой DNS сервер иначе у клиентов не будет доступа в интернет

#. Открытие порта. **WireGuard** будет гонять весь трафик через порт, который был указан выше его необходимо открывать
   в роутере либо в настройках сети в облаке (если это VPS сервер)

   .. note::
   Для пропуска всего трафик через VPN сервер указать Source ``0.0.0.0/0`` и соответсвующий порт указанный в конфигурации

#. Корректировка конфигурации. Открываем конфигурацию сервера ``/etc/wireguard/wg0.conf``, добавляем правила маршрутизации
   для ``ip table``. В итоге файл примет подобный вид:

   .. literalinclude:: linux_files/vpn/wg0_serv.conf
      :language: ini
      :linenos:

#. Запускаем сервер ``sudo wg-quick up wg0``

Настройка клиента
*****************

На машину клиента так же необходимо установить **WireGuard** (необязательно через **PiVPN**). Далее на сервере сгенерируем конфигруция нового клиента.
выполним ``pivpn add`` вводим имя клиента, после этого в конфигурации сервера ``/etc/wireguard/wg0.conf`` в разделе ``Peer``
добавится информация о новом клиенте. Кроме этого **PiVPN** сгенерирует файл конфигурации ``~/configs/NAME_CLIENT.conf``
вида:

.. literalinclude:: linux_files/vpn/wg0_client.conf
   :language: ini
   :linenos:

этот файл необходимо переименовать и положить на клиента по пути ``/etc/wireguard/wg0.conf``. Далее так же запустим VPN командой ``sudo wg-quick up wg0``.