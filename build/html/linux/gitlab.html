<!DOCTYPE html>
<html class="writer-html5" lang="ru" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GitLab &mdash; документация Общие заметки 1</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/read_the_docs_conf.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/translations.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Алфавитный указатель" href="../genindex.html" />
    <link rel="search" title="Поиск" href="../search.html" />
    <link rel="next" title="WireGuard" href="vpn.html" />
    <link rel="prev" title="Manjaro" href="manjaro.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Общие заметки
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Поиск в документации" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Меню навигации">
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="_list.html">Linux</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="cmd_general.html">CMD</a></li>
<li class="toctree-l2"><a class="reference internal" href="manjaro.html">Manjaro</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">GitLab</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">Первичная настройка</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">Резервное копирование</a></li>
<li class="toctree-l3"><a class="reference internal" href="#runner">Runner</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ssl">Настройка SSL</a></li>
<li class="toctree-l3"><a class="reference internal" href="#registry">Registry</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ldap">LDAP</a></li>
<li class="toctree-l3"><a class="reference internal" href="#faq">FAQ</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="vpn.html">WireGuard</a></li>
<li class="toctree-l2"><a class="reference internal" href="ldap.html">LDAP</a></li>
<li class="toctree-l2"><a class="reference internal" href="kvm.html">KVM</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Меню навигации для мобильных устройств" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Общие заметки</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Навигация по страницам">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="_list.html">Linux</a> &raquo;</li>
      <li>GitLab</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/linux/gitlab.rst.txt" rel="nofollow"> Просмотреть исходный код страницы</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="gitlab">
<h1>GitLab<a class="headerlink" href="#gitlab" title="Ссылка на этот заголовок"></a></h1>
<p>Рассматривается вариант развернутый с помощью Docker. Ниже будут представлены ссылки на официальные
инструкции и указаны особенности. Так же в разделе <a class="reference internal" href="#gitlab-runner"><span class="std std-ref">Runner</span></a> указано как запустить GitLab вместе с CI/CD.
При развертывании системы где имеется <strong>SELinux</strong> необходимо дополнительно выполнить действия по ссылке</p>
<div class="admonition attention">
<p class="admonition-title">Внимание</p>
<p>Если используется <strong>SELinux</strong> перед началом изучите пункт <a class="reference external" href="https://docs.gitlab.com/runner/install/docker.html#selinux">docker selinux</a>
и поправьте приложенные ниже конфигурации в соответсвии с инструкцией (добавив <code class="docutils literal notranslate"><span class="pre">:Z</span></code> к монтируемым томам)
иначе получите ошибку о недоступном <code class="docutils literal notranslate"><span class="pre">docker.sock</span></code></p>
</div>
<div class="section" id="id1">
<h2>Первичная настройка<a class="headerlink" href="#id1" title="Ссылка на этот заголовок"></a></h2>
<p>Официальная инструкция расположена в разделе <a class="reference external" href="https://docs.gitlab.com/ee/install/docker.html">docker</a>. Запустить
GitLab в Docker можно несколькими способами самый оптимальный с помощью <code class="docutils literal notranslate"><span class="pre">docker-compose.yml</span></code> (можно обойтись без compose
если нужно запустить GitLab без Runner и прочего, но лучше сразу написать файл <code class="docutils literal notranslate"><span class="pre">docker-compose.yml</span></code>)
Конфигурирование происходит либо прямой правкой файла конфигурации <code class="docutils literal notranslate"><span class="pre">/srv/gitlab/config/gitlab.rb</span></code> (путь может отличаться)
либо при запуске контейнера с помощью переменной среды <a class="reference external" href="https://docs.gitlab.com/ee/install/docker.html#pre-configure-docker-container">подробнее</a>. <br /></p>
<p><strong>На что необходимо обратить внимание:</strong></p>
<ol class="arabic simple">
<li><p>Подмена адреса в <code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code> <br />
Если необходимо получить доступ к GitLab на локальной машине не по адресу <a class="reference external" href="http://localhost/">localhost</a>.
то необходимо добавить строку вида <code class="docutils literal notranslate"><span class="pre">127.0.1.1</span>&#160; <span class="pre">my.newdomen.com</span></code></p></li>
<li><p>Правка парметра <code class="docutils literal notranslate"><span class="pre">external_url...</span></code> <br />
Для того что бы GitLab знал свой настоящий адрес (генерировал верные ссылки для клонирования, реистрации токенов и прочего)
необходимо в файле конфигурации указать верный <code class="docutils literal notranslate"><span class="pre">external_url</span></code>.</p></li>
</ol>
</div>
<div class="section" id="id3">
<h2>Резервное копирование<a class="headerlink" href="#id3" title="Ссылка на этот заголовок"></a></h2>
<p>GitLab имеет встроенные средства позволяющие создавать и восстанавливать резервные копии настроек, репозиториев и т.д.
Можно перенести всю информацию с одной машины на другую <a class="reference external" href="https://docs.gitlab.com/ee/raketasks/backup_restore.html">подробнее</a></p>
<div class="section" id="id5">
<h3>Создание копии<a class="headerlink" href="#id5" title="Ссылка на этот заголовок"></a></h3>
<ol class="arabic simple">
<li><p>Резервирование образа <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">save</span> <span class="pre">-o</span> <span class="pre">/путь/до/места/хранения/image_gitlab.tar</span> <span class="pre">[имя</span> <span class="pre">контейнера</span> <span class="pre">или</span> <span class="pre">ID]</span></code></p></li>
<li><p>Резервирование данных <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">exec</span> <span class="pre">-it</span> <span class="pre">gitlab</span> <span class="pre">gitlab-backup</span> <span class="pre">create</span></code></p></li>
</ol>
<p>Файл данных контейнера будет находиться по пути: <code class="docutils literal notranslate"><span class="pre">/srv/gitlab/data/backups</span></code> и иметь вид <code class="docutils literal notranslate"><span class="pre">1548856817_2021_08_30_14.2.1_gitlab_backup.tar</span></code>.</p>
<div class="admonition attention">
<p class="admonition-title">Внимание</p>
<p>Для переноса конфигурации на другую машину так же необходимы файлы: <code class="docutils literal notranslate"><span class="pre">/srv/gitlab/config/gitlab-secrets.json</span></code> и <code class="docutils literal notranslate"><span class="pre">/srv/gitlab/config/gitlab.rb</span></code></p>
</div>
</div>
<div class="section" id="id6">
<h3>Восстановление копии<a class="headerlink" href="#id6" title="Ссылка на этот заголовок"></a></h3>
<p>Если цель перенести конфигурацию с одной машины на другую необходимо:</p>
<ol class="arabic simple">
<li><p>Положить файл с данными вида <code class="docutils literal notranslate"><span class="pre">1548856817_2021_08_30_14.2.1_gitlab_backup.tar</span></code> по пути <code class="docutils literal notranslate"><span class="pre">/srv/gitlab/data/backups</span></code></p></li>
<li><p>Положить файл ключа вида <code class="docutils literal notranslate"><span class="pre">gitlab-secrets.json</span></code> по пути <code class="docutils literal notranslate"><span class="pre">/srv/gitlab/config/</span></code></p></li>
<li><p>Восстановим образ Docker (если необходимо) <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">load</span> <span class="pre">-i</span> <span class="pre">/путь/до/места/хранения/image_gitlab.tar</span></code></p></li>
<li><p>Если контейнер работает, остановим процессы <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">exec</span> <span class="pre">-it</span> <span class="pre">gitlab</span> <span class="pre">gitlab-ctl</span> <span class="pre">stop</span> <span class="pre">unicorn</span></code>, <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">exec</span> <span class="pre">-it</span> <span class="pre">gitlab</span> <span class="pre">gitlab-ctl</span> <span class="pre">stop</span> <span class="pre">puma</span></code>, <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">exec</span> <span class="pre">-it</span> <span class="pre">gitlab</span> <span class="pre">gitlab-ctl</span> <span class="pre">stop</span> <span class="pre">sidekiq</span></code></p></li>
<li><p>Убедимся что процессы остановлены <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">exec</span> <span class="pre">-it</span> <span class="pre">gitlab</span> <span class="pre">gitlab-ctl</span> <span class="pre">status</span></code></p></li>
<li><p>Восстановим данные <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">exec</span> <span class="pre">-it</span> <span class="pre">gitlab</span> <span class="pre">gitlab-backup</span> <span class="pre">restore</span> <span class="pre">BACKUP=1548856817_2021_08_30_14.2.1</span></code> (см. примечание ниже)</p></li>
<li><p>Перезапустим контейнер <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">restart</span> <span class="pre">gitlab</span></code></p></li>
<li><p>Проверим ошибки <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">exec</span> <span class="pre">-it</span> <span class="pre">gitlab</span> <span class="pre">gitlab-rake</span> <span class="pre">gitlab:check</span> <span class="pre">SANITIZE=true</span></code></p></li>
</ol>
<div class="admonition attention">
<p class="admonition-title">Внимание</p>
<p>При восстановлении данных с другой машины может возникнуть ошибка прав доступа для этого необходимо изменить владельца
файла или <strong>архивировать бэкап на той же машине где он был создан</strong> тогда права не изменяться</p>
</div>
</div>
</div>
<div class="section" id="runner">
<span id="gitlab-runner"></span><h2>Runner<a class="headerlink" href="#runner" title="Ссылка на этот заголовок"></a></h2>
<p>Агент выполняющий задания CI/CD. Не входит в образ GitLab и устанавливается и настраивается отдельно. Есть два основных способа (запуск
в контейнере или отдельным приложением на хостовой машине). Предпочтительный способом через Docker, но и он же сложнее в организации.
Runner умеет выполнять задачи в различных окружениях. Основные это <code class="docutils literal notranslate"><span class="pre">shell</span></code> (выполняет задачу непосредственно на хостовой машине где установлен),
<code class="docutils literal notranslate"><span class="pre">docker</span></code> (выполняет задачу в образе docker). Метод выбирается при регистрации runner либо прописывается в файле конфигурации
Ниже будет описан именно этот метод <a class="reference external" href="https://docs.gitlab.com/runner/install/">подробнее о установке</a>.</p>
<div class="admonition attention">
<p class="admonition-title">Внимание</p>
<p>Если Runner работает в Docker с включенным кэш, то необходимо вручную очищать созданные контейнеры и разделы (volume)
иначе диск быстро забивается мусором! Скрипт можно найти в самом Runner по пути <code class="docutils literal notranslate"><span class="pre">usr/share/gitlab-runner/clear-docker-cache</span></code>.
Можно скопировать его и выполнять раз в какое то время (для справки запустить <code class="docutils literal notranslate"><span class="pre">./clear-docker-cache</span> <span class="pre">help</span></code>)</p>
</div>
<div class="section" id="id8">
<h3>Запуск<a class="headerlink" href="#id8" title="Ссылка на этот заголовок"></a></h3>
<ol class="arabic">
<li><p>Необходимо написать файл запуска и настройки <code class="docutils literal notranslate"><span class="pre">docker-compose.yml</span></code>. Рабочий пример представлен ниже <a class="reference download internal" download="" href="../_downloads/d72192e0e41c9a157a7f0cdcc4e7216d/docker-compose.yml"><code class="xref download docutils literal notranslate"><span class="pre">Скачать</span></code></a></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">version</span><span class="p">:</span> <span class="s">&#39;3&#39;</span>
<span class="nt">services</span><span class="p">:</span>
  <span class="nt">gitlab</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="s">&#39;gitlab/gitlab-ce:latest&#39;</span>
    <span class="nt">restart</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">always</span>
    <span class="nt">hostname</span><span class="p">:</span> <span class="s">&#39;gitlab_test.com&#39;</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="nt">GITLAB_OMNIBUS_CONFIG</span><span class="p">:</span> <span class="p p-Indicator">|</span>
        <span class="no">external_url &#39;http://gitlab_test.com/&#39;</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;80:80&#39;</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;443:443&#39;</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;2022:22&#39;</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;/srv/gitlab/config:/etc/gitlab&#39;</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;/srv/gitlab/logs:/var/log/gitlab&#39;</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;/srv/gitlab/data:/var/opt/gitlab&#39;</span>
    <span class="nt">networks</span><span class="p">:</span>
      <span class="nt">default</span><span class="p">:</span>
        <span class="nt">aliases</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&#39;gitlab_test.com&#39;</span>

  <span class="nt">gitlab-runner</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="s">&#39;gitlab/gitlab-runner:latest&#39;</span>
    <span class="nt">depends_on</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;gitlab&#39;</span>
    <span class="nt">restart</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">always</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;/srv/gitlab-runner/config:/etc/gitlab-runner&#39;</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;/var/run/docker.sock:/var/run/docker.sock&#39;</span>
    <span class="nt">networks</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;default&#39;</span>

<span class="nt">networks</span><span class="p">:</span>
  <span class="nt">default</span><span class="p">:</span>
    <span class="nt">driver</span><span class="p">:</span> <span class="s">&#39;bridge&#39;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Примечание</p>
<p>Так как GitLab и Runner два обособленных контейнера, но им необходимо обмениваться данными нужно организовать сеть между контейнерами.
это реализует блок <code class="docutils literal notranslate"><span class="pre">networks</span></code>. <strong>Имя создаваемой сети зависит от каталога в котором запущен</strong> <code class="docutils literal notranslate"><span class="pre">docker-compose.yml</span></code>. Например если <code class="docutils literal notranslate"><span class="pre">docker-compose.yml</span></code>
лежит в каталоге  с именем <code class="docutils literal notranslate"><span class="pre">git</span></code>, то создается сеть <code class="docutils literal notranslate"><span class="pre">git_default</span></code> Подробнее можно прочитать <a class="reference external" href="https://stackoverflow.com/questions/50325932/gitlab-runner-docker-could-not-resolve-host/">тут</a></p>
</div>
</li>
<li><p>Запустим контейнеры и сеть между ними (находясь в каталоге конфигурации) <code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">up</span> <span class="pre">-d</span></code></p></li>
</ol>
</div>
<div class="section" id="gitlab-runner-settings">
<span id="id10"></span><h3>Настройка<a class="headerlink" href="#gitlab-runner-settings" title="Ссылка на этот заголовок"></a></h3>
<p>Конфигурация runner храниться в файле <code class="docutils literal notranslate"><span class="pre">/srv/gitlab-runner/config/config.toml</span></code> (либо иное место если указан другой путь монтирования).
Процесс конфигурации подразумевает регистрацию runner в Gitlab. Отредактировать конфигурацию (зарегистрировать) можно двумя способами <a class="reference external" href="https://docs.gitlab.com/runner/register/">подробнее</a> :</p>
<ol class="arabic">
<li><p><strong>Интерактивный режим</strong> <br />
Выполним <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">exec</span> <span class="pre">-it</span> <span class="pre">gitlab_gitlab-runner_1</span> <span class="pre">gitlab-runner</span> <span class="pre">register</span></code> и следуем указаниям (для работоспособности все равно необходимо
править конфигурацию вручную) этот метод может сформировать каркас конфигурации, но для runner запущенноо в Docker этого не достаточно</p></li>
<li><p><strong>Правка конфигурации</strong> <br />
Пример рабочей конфигурации ( <a class="reference external" href="https://docs.gitlab.com/runner/configuration/advanced-configuration.html">полное описание</a>  ) <a class="reference download internal" download="" href="../_downloads/a18cf2a398bb4b822d0115119c1d7320/config.toml"><code class="xref download docutils literal notranslate"><span class="pre">Скачать</span></code></a></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">concurrent = 1</span>
<span class="l l-Scalar l-Scalar-Plain">check_interval = 0</span>

<span class="l l-Scalar l-Scalar-Plain">[session_server]</span>
  <span class="l l-Scalar l-Scalar-Plain">session_timeout = 1800</span>

<span class="l l-Scalar l-Scalar-Plain">[[runners]]</span>
  <span class="l l-Scalar l-Scalar-Plain">name = &quot;stm32&quot;</span> <span class="c1">#Имя</span>
  <span class="l l-Scalar l-Scalar-Plain">url = &quot;http://gitlab_test.com/&quot;</span> <span class="c1">#Адрес по которому доступен GitLab</span>
  <span class="l l-Scalar l-Scalar-Plain">token = &quot;yKFH-aCHozA75XcYU-CU&quot;</span> <span class="c1">#Токен для регистрации (выдается GitLab)</span>
  <span class="l l-Scalar l-Scalar-Plain">executor = &quot;docker&quot;</span>
  <span class="l l-Scalar l-Scalar-Plain">[runners.custom_build_dir]</span>
  <span class="l l-Scalar l-Scalar-Plain">[runners.cache]</span>
    <span class="l l-Scalar l-Scalar-Plain">[runners.cache.s3]</span>
    <span class="l l-Scalar l-Scalar-Plain">[runners.cache.gcs]</span>
    <span class="l l-Scalar l-Scalar-Plain">[runners.cache.azure]</span>
  <span class="l l-Scalar l-Scalar-Plain">[runners.docker]</span> <span class="c1">#Настройки если исполнителем выбран docker</span>
    <span class="l l-Scalar l-Scalar-Plain">tls_verify = false</span>
    <span class="l l-Scalar l-Scalar-Plain">image = &quot;ubuntu:latest&quot;</span> <span class="c1">#Образ по-умолчанию, если в .gitlab-ci.yml не указано ничего</span>
    <span class="l l-Scalar l-Scalar-Plain">privileged = true</span>
    <span class="l l-Scalar l-Scalar-Plain">disable_entrypoint_overwrite = false</span>
    <span class="l l-Scalar l-Scalar-Plain">oom_kill_disable = false</span>
    <span class="l l-Scalar l-Scalar-Plain">network_mode = &quot;gitlab_default&quot;</span> <span class="c1">#Важный параметр для моста между контейнерами см. описание</span>
    <span class="l l-Scalar l-Scalar-Plain">pull_policy = &quot;if-not-present&quot;</span> <span class="c1">#Если есть локальный image использовать его</span>
    <span class="l l-Scalar l-Scalar-Plain">disable_cache = false</span>
    <span class="l l-Scalar l-Scalar-Plain">volumes = [&quot;/var/run/docker.sock:/var/run/docker.sock&quot;, &quot;/cache&quot;]</span>
    <span class="l l-Scalar l-Scalar-Plain">shm_size = 0</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Примечание</p>
<p>Значение строки <code class="docutils literal notranslate"><span class="pre">network_mode</span> <span class="pre">=</span></code> формируется из имени службы и имени указаном в <code class="docutils literal notranslate"><span class="pre">docker-compose.yml</span></code>
Например имя службы <code class="docutils literal notranslate"><span class="pre">infrastructure</span></code>, имя сети <code class="docutils literal notranslate"><span class="pre">backend</span></code> тогда строка примет вид <code class="docutils literal notranslate"><span class="pre">network_mode</span> <span class="pre">=</span> <span class="pre">&quot;infrastructure_backend&quot;</span></code>
Для просмотра всех созданных сетей можно выполнить <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">network</span> <span class="pre">ls</span></code></p>
</div>
<div class="admonition attention">
<p class="admonition-title">Внимание</p>
<p>Включение параметра <code class="docutils literal notranslate"><span class="pre">privileged</span> <span class="pre">=</span> <span class="pre">true</span></code> и <code class="docutils literal notranslate"><span class="pre">volumes</span> <span class="pre">=</span> <span class="pre">[&quot;/var/run/docker.sock:/var/run/docker.sock&quot;...</span></code> предоставляют
Runner расширенные права доступа. Устанавливать только при необходимости (например при использование <strong>Gitlab Registry</strong>)</p>
</div>
</li>
</ol>
<p>Если runner все же решено запускать отдельным приложением а GitLab запущен в Docker обратите внимание на следующее</p>
<ol class="arabic simple">
<li><p>Manjaro имеет в стандартном репозитории gitlab-runner</p></li>
<li><p>После установки для автозапуска необходимо включить сервис <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">systemctl</span> <span class="pre">enable</span> <span class="pre">gitlab-runner.service</span> <span class="pre">--now</span></code></p></li>
<li><p>Файл конфигурации расположен <code class="docutils literal notranslate"><span class="pre">/etc/gitlab-runner/config/config.toml</span></code></p></li>
<li><p>Параметр <code class="docutils literal notranslate"><span class="pre">network_mode</span> <span class="pre">=</span></code> будет иметь вид <code class="docutils literal notranslate"><span class="pre">network_mode</span> <span class="pre">=</span> <span class="pre">&quot;host&quot;</span></code></p></li>
</ol>
</div>
</div>
<div class="section" id="ssl">
<h2>Настройка SSL<a class="headerlink" href="#ssl" title="Ссылка на этот заголовок"></a></h2>
<p>Для работы GitLab через протокол <strong>https</strong> необходимо:</p>
<ol class="arabic">
<li><p>Получить сертификат, его можно сгенерировать с помощью <code class="docutils literal notranslate"><span class="pre">openssl</span></code></p>
<ul>
<li><p>Выполним команду генерации сертификата (должен содержать поле <code class="docutils literal notranslate"><span class="pre">subjectAltName</span></code>):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>openssl req -newkey rsa:4096 -nodes -sha256 -keyout  ./server.key -x509 -days <span class="m">3650</span> -out ./server.crt -addext <span class="s2">&quot;subjectAltName = DNS:git2.uonmap.com, DNS:uonmap.com, DNS:192.168.0.61&quot;</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="c1"># ./server.key - имя для сгенерированного ключа</span>
<span class="linenos">4</span><span class="c1"># ./server.crt - имя самого сертификата</span>
<span class="linenos">5</span><span class="c1"># subjectAltName - поле необходимо для корректной авторизации клиентов в gitlab registry</span>
<span class="linenos">6</span><span class="c1">#                  тут прописываем все возможные домены ресурса</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Примечание</p>
<p>при заполнении полей некоторые необходимо заполнять внимательно. Первое
поле <code class="docutils literal notranslate"><span class="pre">Country</span> <span class="pre">Name</span></code> код из двух символов например <code class="docutils literal notranslate"><span class="pre">ru</span></code>. Очень важно верно заполнить
поле <code class="docutils literal notranslate"><span class="pre">Common</span> <span class="pre">Name</span> <span class="pre">(e.g.</span> <span class="pre">server</span> <span class="pre">FQDN</span> <span class="pre">or</span> <span class="pre">YOUR</span> <span class="pre">name)</span></code> оно должно полностью соответствовать <code class="docutils literal notranslate"><span class="pre">external_url</span></code> (без <code class="docutils literal notranslate"><span class="pre">https://</span></code>)
например для конфигурации приведенной выше это будет <code class="docutils literal notranslate"><span class="pre">gitlab_test.com</span></code></p>
</div>
<p>в результате нужно 2 файла <code class="docutils literal notranslate"><span class="pre">server.key</span></code>, <code class="docutils literal notranslate"><span class="pre">server.crt</span></code></p>
</li>
<li><p>Отредактируем конфигурацию GitLab <code class="docutils literal notranslate"><span class="pre">/srv/gitlab/config/gitlab.rb</span></code>
(или можно добавить эти параметры на этапе создания контейнера) приводим поля к виду:</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>external_url <span class="s1">&#39;https://gitlab_test.com&#39;</span>
nginx<span class="o">[</span><span class="s1">&#39;enable&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="nb">true</span>
nginx<span class="o">[</span><span class="s1">&#39;client_max_body_size&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;250m&#39;</span>
nginx<span class="o">[</span><span class="s1">&#39;redirect_http_to_https&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="nb">true</span>
nginx<span class="o">[</span><span class="s1">&#39;ssl_certificate&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;/etc/gitlab/server.crt&quot;</span>
nginx<span class="o">[</span><span class="s1">&#39;ssl_certificate_key&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;/etc/gitlab/server.key&quot;</span>
nginx<span class="o">[</span><span class="s1">&#39;ssl_protocols&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;TLSv1.2 TLSv1.3&quot;</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Обновим конфигурацию <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">exec</span> <span class="pre">-it</span> <span class="pre">NAME_CONT</span> <span class="pre">gitlab-ctl</span> <span class="pre">reconfigure</span></code></p></li>
</ul>
</li>
<li><p>Настройка Runner</p>
<p>Полученный сертификат <code class="docutils literal notranslate"><span class="pre">server.crt</span></code> копируем в каталог <code class="docutils literal notranslate"><span class="pre">/srv/gitlab-runner/config</span></code>
можно так же смонтировать каталог где находиться сертификат что бы все было в единичном экземпляре (более правильно)
далее регистрируем Runner. Заходим в контейнер <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">exec</span> <span class="pre">-it</span> <span class="pre">NAME_CONT</span> <span class="pre">bash</span></code> выполняем
<code class="docutils literal notranslate"><span class="pre">gitlab-runner</span> <span class="pre">register</span> <span class="pre">--tls-ca-file=/etc/gitlab-runner/server.crt</span></code> после регистрации корректируем конфигурацию
<code class="docutils literal notranslate"><span class="pre">/srv/gitlab-runner/config/config.toml</span></code> в соответсвии с рекомендациями <a class="reference internal" href="#gitlab-runner-settings"><span class="std std-ref">Настройка</span></a></p>
</li>
</ol>
</div>
<div class="section" id="registry">
<h2>Registry<a class="headerlink" href="#registry" title="Ссылка на этот заголовок"></a></h2>
<p>Для активации встроенного в GitLab движка <strong>Registry</strong> необходимо отредактировать конфигурацию GitLab <code class="docutils literal notranslate"><span class="pre">/srv/gitlab/config/gitlab.rb</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>registry_external_url <span class="s1">&#39;такой_же_как_и_external_url:5555&#39;</span> <span class="c1">#например https://gitlab_test.com:5555</span>
registry_nginx<span class="o">[</span><span class="s1">&#39;enable&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="nb">true</span>
registry_nginx<span class="o">[</span><span class="s1">&#39;listen_port&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="m">5555</span>
</pre></div>
</div>
<p>Так же необходимо пробростить указанный порт (5555) из контенера наружу (на хост) и
на хосте в файле <code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code> прописать домен (например <code class="docutils literal notranslate"><span class="pre">127.0.0.1</span> <span class="pre">git2.uonmap.com</span></code>)
тогда можно попробовать залогиниться с хоста <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">login</span> <span class="pre">git2.uonmap.com:5555</span></code>.
Ввести логин пароль от учетной записи GitLab</p>
<p>Для успешной авторизации с другой машины в сети на клиенте необходимо установить сертификат для Docker.
Копируем файл <code class="docutils literal notranslate"><span class="pre">server.crt</span></code> в каталог <code class="docutils literal notranslate"><span class="pre">/etc/docker/certs.d/git2.uonmap.com:5555/ca.crt</span></code> и переименовываем в <code class="docutils literal notranslate"><span class="pre">ca.crt</span></code>
где <code class="docutils literal notranslate"><span class="pre">git2.uonmap.com:5555</span></code> адрес Registry на машину с которой хотим авторизоваться.</p>
<div class="admonition attention">
<p class="admonition-title">Внимание</p>
<p>Если Registry работает в том же экземпляре (внутри GitLab) необходимо раз в какое то время удалять неиспользуемые слои и образы.
Можно выполнить <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">exec</span> <span class="pre">-it</span> <span class="pre">gitlab</span> <span class="pre">gitlab-ctl</span> <span class="pre">registry-garbage-collect</span> <span class="pre">-m</span></code> <a class="reference external" href="https://docs.gitlab.com/ee/administration/packages/container_registry.html#removing-untagged-manifests-and-unreferenced-layers">подробнее</a>
По идеи эта команда должна удалить все лишнее из Registry, но почему то образы без тегов (временные слои видимо) остаются,
можно выполнить еще <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">rmi</span> <span class="pre">$(docker</span> <span class="pre">images</span> <span class="pre">-f</span> <span class="pre">&quot;dangling=true&quot;</span> <span class="pre">-q)</span> <span class="pre">--force</span></code> это наверника удалит все образы без тегов</p>
</div>
</div>
<div class="section" id="ldap">
<h2>LDAP<a class="headerlink" href="#ldap" title="Ссылка на этот заголовок"></a></h2>
<p>ПОКА ТУТ ПУСТО</p>
</div>
<div class="section" id="faq">
<h2>FAQ<a class="headerlink" href="#faq" title="Ссылка на этот заголовок"></a></h2>
<div class="section" id="runner-gitlab">
<h3>Что делать если runner настроен, но GitLab все равно говорит об ожидании<a class="headerlink" href="#runner-gitlab" title="Ссылка на этот заголовок"></a></h3>
<p>По умолчанию параметр <span class="guilabel">Run untagged jobs</span>  по пути <span class="menuselection">Settings ‣ CI/CD ‣ Runner</span> (на выбранном runner кликнуть иконку карандаша)
отключен. Это значит если тег runner не совпадает с тегом репозитория, то runner не будет использован в этом репозитории. Можно
отметить галочку, тогда теги будут игнорироваться</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/runner_tag.png"><img alt="../_images/runner_tag.png" src="../_images/runner_tag.png" style="width: 508.8px; height: 308.40000000000003px;" /></a>
</div>
</div>
<div class="section" id="readonly">
<h3>Как перевести в режим ReadOnly<a class="headerlink" href="#readonly" title="Ссылка на этот заголовок"></a></h3>
<p>Для перевода всего экземпляра GitLab необходимо отредактировать файл (путь указан внутри контейнера)
<code class="docutils literal notranslate"><span class="pre">/opt/gitlab/embedded/service/gitlab-rails/lib/gitlab/database.rb</span></code> параметр <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">self.read_only</span></code>
выставить значение <code class="docutils literal notranslate"><span class="pre">true</span></code>. Выполнить реконфигурацию <code class="docutils literal notranslate"><span class="pre">gitlab-ctl</span> <span class="pre">reconfigure</span></code> и перезапуск контейнера</p>
</div>
<div class="section" id="submodule-ci-cd">
<h3>Submodule ошибка сборки при CI/CD<a class="headerlink" href="#submodule-ci-cd" title="Ссылка на этот заголовок"></a></h3>
<p>Если необходимо подключить submodule для репозитория, который храниться на этом же сервере, то необходимо в файле <code class="docutils literal notranslate"><span class="pre">.gitmodules</span></code> текущего проекта
прописывать относительный путь на ссылаемый репозиторий иначе при сборке проекта через CI/CD будет появляться ошибка вида <code class="docutils literal notranslate"><span class="pre">fatal:</span> <span class="pre">could</span> <span class="pre">not</span> <span class="pre">read</span> <span class="pre">Username</span> <span class="pre">for</span> <span class="pre">'https://gitlab.com':</span> <span class="pre">No</span> <span class="pre">such</span> <span class="pre">device</span> <span class="pre">or</span> <span class="pre">address</span></code>
<a class="reference external" href="https://docs.gitlab.com/ee/ci/git_submodules.html#configure-the-gitmodules-file">подробнее тут</a></p>
<p>Пример файла <code class="docutils literal notranslate"><span class="pre">.gitmodules</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>submodule <span class="s2">&quot;proto_contracts&quot;</span><span class="o">]</span>
    <span class="nv">path</span> <span class="o">=</span> proto_contracts
    <span class="nv">url</span> <span class="o">=</span> https://gitlab.com/areller/proto_contracts.git <span class="c1"># Эту строку заменить на строку ниже</span>
    <span class="nv">url</span> <span class="o">=</span> ../../areller/proto_contracts.git
</pre></div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Нижняя область">
        <a href="manjaro.html" class="btn btn-neutral float-left" title="Manjaro" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Предыдущая</a>
        <a href="vpn.html" class="btn btn-neutral float-right" title="WireGuard" accesskey="n" rel="next">Следующая <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021.</p>
  </div>

  Собрано при помощи <a href="https://www.sphinx-doc.org/">Sphinx</a> с использованием
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">темы,</a>
    предоставленной <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>